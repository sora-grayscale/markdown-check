name: ðŸ“ Markdown Format Check

on:
  pull_request:
    paths:
      - 'docs/*.md'
      - 'README.md'
      - '.markdownlint.json'
      - '.markdown-link-check.json'

# ========== ç’°å¢ƒå¤‰æ•°ã§Markdownãƒ‘ã‚¹ã‚’å®šç¾© ==========
env:
  MD_PATHS: '"docs/*.md" "README.md"'
  MD_GLOB_PATTERN: 'docs/*.md README.md'

jobs:
  markdown-lint:
    name: ðŸ” Markdown Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install markdownlint-cli
      run: npm install -g markdownlint-cli
      
    - name: ðŸ” Run markdownlint
      run: markdownlint ${{ env.MD_PATHS }} --config .markdownlint.json
      
    - name: ðŸ“Š Comment PR with results
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âŒ **Markdownã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**\n\nè©³ç´°ã¯[Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nä¿®æ­£å¾Œã€å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚ ðŸ”§'
          })

  markdown-format:
    name: ðŸ“ Markdown Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ðŸ“¦ Install prettier
      run: npm install -g prettier
      
    - name: ðŸŽ¨ Check Prettier formatting
      run: prettier --check ${{ env.MD_PATHS }}
      
    - name: ðŸ“ Generate format diff (if failed)
      if: failure()
      run: |
        echo "## ðŸ“ Formatting Suggestions" >> format-diff.md
        echo "" >> format-diff.md
        prettier --list-different ${{ env.MD_PATHS }} || true
        echo "ä¸Šè¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã®å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚" >> format-diff.md
        
    - name: ðŸ“Š Upload format diff
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: format-suggestions
        path: format-diff.md

  link-checker:
    name: ðŸ”— Link Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ðŸ“¦ Install markdown-link-check
      run: npm install -g markdown-link-check
      
    - name: ðŸ”— Check markdown links
      run: |
        # æŒ‡å®šã•ã‚ŒãŸMarkdownãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
        for file in ${{ env.MD_GLOB_PATTERN }}; do
          if [ -f "$file" ]; then
            echo "Checking links in: $file"
            markdown-link-check "$file" --config .markdown-link-check.json
          fi
        done

  summary:
    name: ðŸ“‹ Check Summary
    runs-on: ubuntu-latest
    needs: [markdown-lint, markdown-format, link-checker]
    if: always()
    
    steps:
    - name: ðŸ“Š Generate summary
      run: |
        echo "## ðŸ“ Markdownå“è³ªãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ãƒã‚§ãƒƒã‚¯å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ env.MD_GLOB_PATTERN }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.markdown-lint.result }}" == "success" ]; then
          echo "âœ… **Markdown Lint**: ãƒ‘ã‚¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Markdown Lint**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.markdown-format.result }}" == "success" ]; then
          echo "âœ… **Format Check**: ãƒ‘ã‚¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Format Check**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.link-checker.result }}" == "success" ]; then
          echo "âœ… **Link Check**: ãƒ‘ã‚¹" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Link Check**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°ã¯å„ã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY